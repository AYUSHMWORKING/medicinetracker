<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creative Medication Tracker</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Chosen Palette: Warm Neutrals with Indigo/Blue/Green Accents */
        /* Application Structure Plan: The application is structured into distinct, vertically stacked sections: Header, Today's Checklist, All Medications List, and Refill Status. A modal provides a dedicated interface for managing medications (add, edit, delete). This modular card-based layout facilitates clear information grouping and easy navigation by scrolling. Key interactions include ticking off daily meds, managing medication details via a form, and generating LLM-powered insights. This structure was chosen for its intuitive flow and ability to present diverse information types clearly within a single page. */
        /* Visualization & Content Choices:
        - Today's Checklist: Textual medication names, dosages, and interactive buttons. Goal: Daily tracking. Presentation: Grouped lists with toggle buttons. Interaction: Button click marks taken, decrements stock. Justification: Direct interaction for daily task. Method: HTML/CSS/JS.
        - All Medications List: Tabular display of medication details. Goal: Overview of all registered meds. Presentation: Table. Interaction: Button to open management modal. Justification: Tabular format is efficient for structured data. Method: HTML/CSS/JS.
        - Refill Status: List of medications with stock levels and supply days. Goal: Monitor stock and anticipate refills. Presentation: List with dynamic status text/colors/icons. Interaction: Button to generate LLM-powered reminder. Justification: Clear visual cues for critical stock info. Method: HTML/CSS/JS + LLM.
        - Medication Management Modal: Form for adding/editing medication details including stock. Goal: CRUD operations for medication data. Presentation: Form with input fields and dropdowns. Interaction: Form submission (save), button click (delete), dropdown selection (edit). Justification: Centralized management interface. Method: HTML/CSS/JS.
        - LLM Integration: Buttons to trigger LLM calls for medication info and refill reminders. Goal: Provide intelligent insights and assistance. Presentation: Text output in dedicated areas. Interaction: Button click. Justification: Enhances utility with AI-generated content. Method: HTML/CSS/JS + Gemini API. */
        /* CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. */

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for table on smaller screens */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
            cursor: pointer;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 600px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 p-4 min-h-screen flex items-center justify-center">

    <div class="bg-white rounded-3xl shadow-xl p-6 md:p-10 w-full max-w-4xl border border-gray-100">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2 tracking-tight">My Daily Meds</h1>
            <p id="current-date" class="text-lg text-gray-600 font-medium"></p>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <!-- Today's Checklist Section -->
        <div class="mb-8 p-6 bg-indigo-50 rounded-2xl shadow-inner border border-indigo-100">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4 flex items-center">
                <!-- Checkmark icon -->
                <svg class="w-7 h-7 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Today's Checklist
            </h2>
            <div id="meds-today" class="space-y-4">
                <!-- Medications for today will be dynamically inserted here -->
            </div>
            <button id="reset-daily-status" class="mt-6 w-full md:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-xl shadow-md hover:bg-red-600 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                Reset Daily Status
            </button>
        </div>

        <!-- All Medications List Section -->
        <div class="mb-8 p-6 bg-purple-50 rounded-2xl shadow-inner border border-purple-100">
            <h2 class="text-2xl font-bold text-purple-600 mb-4 flex items-center">
                <!-- Pill bottle icon -->
                <svg class="w-7 h-7 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.5v11m0-11a2 2 0 100-4 2 2 0 000 4zm0 0h.01M12 6.5V12m0 0a2 2 0 100-4 2 2 0 000 4zm0 0h.01M12 12v5.5m0 0a2 2 0 100-4 2 2 0 000 4zm0 0h.01M12 17.5V22m0 0a2 2 0 100-4 2 2 0 000 4zm0 0h.01"></path></svg>
                All Medications
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-xl shadow-md border border-gray-200">
                    <thead>
                        <tr class="bg-purple-100 text-purple-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left rounded-tl-xl">Medication</th>
                            <th class="py-3 px-6 text-left">Dosage</th>
                            <th class="py-3 px-6 text-left">Frequency</th>
                            <th class="py-3 px-6 text-left rounded-tr-xl">Time(s)</th>
                            <th class="py-3 px-6 text-left">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="meds-list" class="text-gray-700 text-sm font-light divide-y divide-gray-100">
                        <!-- Full medication list will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            <button id="manage-meds-btn" class="mt-6 w-full md:w-auto px-6 py-3 bg-blue-500 text-white font-semibold rounded-xl shadow-md hover:bg-blue-600 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">
                Manage Medications
            </button>
        </div>

        <!-- Refill Status Section -->
        <div class="p-6 bg-green-50 rounded-2xl shadow-inner border border-green-100">
            <h2 class="text-2xl font-bold text-green-600 mb-4 flex items-center">
                <!-- Calendar icon -->
                <svg class="w-7 h-7 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                Refill Status
            </h2>
            <ul id="refill-status" class="space-y-3">
                <!-- Refill status will be dynamically inserted here -->
            </ul>
            <button id="generate-refill-reminder-btn" class="mt-6 w-full md:w-auto px-6 py-3 bg-yellow-500 text-white font-semibold rounded-xl shadow-md hover:bg-yellow-600 transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-75">
                âœ¨ Generate Refill Reminder
            </button>
            <div id="refill-reminder-output" class="mt-4 p-4 bg-yellow-100 rounded-lg text-yellow-800 hidden"></div>
        </div>
    </div>

    <!-- Medication Management Modal -->
    <div id="medication-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Manage Medications</h3>

            <!-- Select Medication for Edit/Delete -->
            <div class="mb-4">
                <label for="select-med-to-edit" class="block text-gray-700 text-sm font-bold mb-2">Select Medication:</label>
                <select id="select-med-to-edit" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- Add New or Select to Edit --</option>
                </select>
            </div>

            <!-- Medication Form -->
            <form id="medication-form" class="space-y-4">
                <div>
                    <label for="med-name" class="block text-gray-700 text-sm font-bold mb-2">Medication Name:</label>
                    <input type="text" id="med-name" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="med-dosage" class="block text-gray-700 text-sm font-bold mb-2">Dosage:</label>
                    <input type="text" id="med-dosage" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="med-frequency" class="block text-gray-700 text-sm font-bold mb-2">Frequency:</label>
                    <select id="med-frequency" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="Once daily">Once daily</option>
                        <option value="Twice daily">Twice daily</option>
                        <option value="Thrice daily">Thrice daily</option>
                        <option value="Every other day">Every other day</option>
                        <option value="As needed">As needed</option>
                    </select>
                </div>
                <div>
                    <label for="med-times" class="block text-gray-700 text-sm font-bold mb-2">Time(s) of Day (comma-separated):</label>
                    <input type="text" id="med-times" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., Morning, After Dinner">
                </div>
                <div>
                    <label for="med-notes" class="block text-gray-700 text-sm font-bold mb-2">Notes:</label>
                    <input type="text" id="med-notes" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                 <div>
                    <label for="med-current-stock" class="block text-gray-700 text-sm font-bold mb-2">Current Stock (pills/units):</label>
                    <input type="number" id="med-current-stock" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" required>
                </div>
                <div>
                    <label for="med-pills-per-pack" class="block text-gray-700 text-sm font-bold mb-2">Pills per Pack (for refill calculation):</label>
                    <input type="number" id="med-pills-per-pack" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="1" required>
                </div>
                <div>
                    <label for="med-refill-due" class="block text-gray-700 text-sm font-bold mb-2">Refill Due Date (YYYY-MM-DD):</label>
                    <input type="date" id="med-refill-due" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>

                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="get-med-info-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition-colors">
                        âœ¨ Get Med Info
                    </button>
                    <button type="submit" id="save-med-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition-colors">Save Medication</button>
                    <button type="button" id="delete-med-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline transition-colors">Delete Medication</button>
                </div>
                <div id="med-info-output" class="mt-4 p-4 bg-blue-100 rounded-lg text-blue-800 hidden"></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId;
        let isAuthReady = false;
        let medications = []; // Global array to store medications from Firestore
        let dailyTakenStatus = {}; // Global object to store today's taken status from Firestore

        // Define today and options globally or at module level
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

        // DOM Elements
        const todayDateElement = document.getElementById('current-date');
        const userIdDisplay = document.getElementById('user-id-display');
        const medsTodayContainer = document.getElementById('meds-today');
        const medsListTableBody = document.getElementById('meds-list');
        const refillStatusList = document.getElementById('refill-status');
        const resetDailyStatusButton = document.getElementById('reset-daily-status');
        const manageMedsBtn = document.getElementById('manage-meds-btn');
        const medicationModal = document.getElementById('medication-modal');
        const closeModalBtn = document.querySelector('.modal .close-button');
        const medicationForm = document.getElementById('medication-form');
        const selectMedToEdit = document.getElementById('select-med-to-edit');
        const saveMedBtn = document.getElementById('save-med-btn');
        const deleteMedBtn = document.getElementById('delete-med-btn');
        const getMedInfoBtn = document.getElementById('get-med-info-btn'); // New LLM button
        const medInfoOutput = document.getElementById('med-info-output'); // New LLM output area
        const generateRefillReminderBtn = document.getElementById('generate-refill-reminder-btn'); // New LLM button
        const refillReminderOutput = document.getElementById('refill-reminder-output'); // New LLM output area


        // Form fields
        const medNameInput = document.getElementById('med-name');
        const medDosageInput = document.getElementById('med-dosage');
        const medFrequencySelect = document.getElementById('med-frequency');
        const medTimesInput = document.getElementById('med-times');
        const medNotesInput = document.getElementById('med-notes');
        const medCurrentStockInput = document.getElementById('med-current-stock');
        const medPillsPerPackInput = document.getElementById('med-pills-per-pack');
        const medRefillDueInput = document.getElementById('med-refill-due');

        let currentEditingMedId = null; // To store the ID of the medication being edited

        // --- Firebase Initialization and Authentication ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-med-tracker-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    isAuthReady = true;
                    // Fetch initial data after authentication is ready
                    fetchMedications();
                    fetchDailyStatus();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                        // Fallback if sign-in fails, might display limited functionality
                        isAuthReady = true; // Still set true to allow UI to render, but data will be empty
                        userIdDisplay.textContent = `User ID: Anonymous (Login failed)`;
                        // If Firebase fails, use dummy data to allow UI to render
                        medications = [
                            { id: 'dummy-glycomet', name: 'Glycomet GP2 (Dummy)', dosage: '1 tablet', frequency: 'Twice daily', times: ['Morning', 'Evening'], notes: 'For diabetes', currentStock: 30, pillsPerPack: 60, refillDue: '2025-08-15' },
                        ];
                        renderAllMedsList();
                        renderRefillStatus();
                        renderTodayChecklist();
                    }
                }
            });
        } else {
            console.error("Firebase config not found. App will run without persistence.");
            isAuthReady = true;
            userId = 'local-user-no-firebase';
            userIdDisplay.textContent = `User ID: Local (No persistence)`;
            // Use dummy data if Firebase is not configured
            medications = [
                { id: 'dummy-glycomet', name: 'Glycomet GP2 (Dummy)', dosage: '1 tablet', frequency: 'Twice daily', times: ['Morning', 'Evening'], notes: 'For diabetes', currentStock: 30, pillsPerPack: 60, refillDue: '2025-08-15' },
                { id: 'dummy-sitaday', name: 'Sitaday (Dummy)', dosage: '1 tablet', frequency: 'Twice daily', times: ['Morning', 'Evening'], notes: 'For diabetes', currentStock: 45, pillsPerPack: 60, refillDue: '2025-08-20' },
            ];
            renderAllMedsList();
            renderRefillStatus();
            renderTodayChecklist();
        }

        // --- Utility Functions ---
        const getTodayDateString = () => today.toISOString().split('T')[0]; // YYYY-MM-DD

        const getPillsPerDay = (frequency) => {
            switch (frequency) {
                case 'Once daily': return 1;
                case 'Twice daily': return 2;
                case 'Thrice daily': return 3;
                default: return 1; // Default for 'As needed' or 'Every other day' (might need more complex logic)
            }
        };

        // --- Firestore Data Operations ---

        // Fetch all medications from Firestore
        const fetchMedications = () => {
            if (!isAuthReady || !db || !userId) return;
            const medsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/medications`);
            onSnapshot(medsCollectionRef, (snapshot) => {
                medications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllMedsList();
                renderRefillStatus();
                // Re-render today's checklist to ensure it reflects current medications
                renderTodayChecklist();
                populateMedicationSelect();
            }, (error) => {
                console.error("Error fetching medications:", error);
            });
        };

        // Fetch today's daily intake status from Firestore
        const fetchDailyStatus = () => {
            if (!isAuthReady || !db || !userId) return;
            const todayIntakeDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, getTodayDateString());
            onSnapshot(todayIntakeDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    dailyTakenStatus = docSnap.data().status || {};
                } else {
                    dailyTakenStatus = {};
                }
                renderTodayChecklist(); // Re-render to reflect fetched status
            }, (error) => {
                console.error("Error fetching daily status:", error);
            });
        };

        // Update daily intake status in Firestore
        const updateDailyStatusInFirestore = async (medId, timeBlock, isTaken) => {
            if (!isAuthReady || !db || !userId) return;
            const todayIntakeDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, getTodayDateString());
            const key = medId + '_' + timeBlock;

            // Update local status first for immediate UI feedback
            dailyTakenStatus[key] = isTaken;
            // No need to call saveDailyStatus to localStorage anymore, Firestore is the source of truth

            try {
                await setDoc(todayIntakeDocRef, { status: dailyTakenStatus }, { merge: true });
                // If marking as taken, decrement stock
                if (isTaken) {
                    const medRef = doc(db, `artifacts/${appId}/users/${userId}/medications`, medId);
                    await updateDoc(medRef, { currentStock: increment(-1) });
                }
            } catch (error) {
                console.error("Error updating daily status or stock:", error);
                // Revert local status if Firestore update fails
                dailyTakenStatus[key] = !isTaken;
                renderTodayChecklist(); // Re-render to show original state
            }
        };

        // Add/Update medication in Firestore
        const saveMedication = async (event) => {
            event.preventDefault();
            if (!isAuthReady || !db || !userId) return;

            const medData = {
                name: medNameInput.value,
                dosage: medDosageInput.value,
                frequency: medFrequencySelect.value,
                times: medTimesInput.value.split(',').map(t => t.trim()).filter(t => t),
                notes: medNotesInput.value,
                currentStock: parseInt(medCurrentStockInput.value),
                pillsPerPack: parseInt(medPillsPerPackInput.value),
                refillDue: medRefillDueInput.value, // YYYY-MM-DD string
            };

            try {
                if (currentEditingMedId) {
                    // Update existing medication
                    const medRef = doc(db, `artifacts/${appId}/users/${userId}/medications`, currentEditingMedId);
                    await setDoc(medRef, medData, { merge: true });
                    console.log("Medication updated successfully!");
                } else {
                    // Add new medication
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/medications`), medData);
                    console.log("Medication added successfully!");
                }
                medicationModal.classList.remove('show');
                medicationForm.reset();
                currentEditingMedId = null;
                medInfoOutput.classList.add('hidden'); // Hide LLM output on save
                medInfoOutput.innerHTML = '';
            } catch (error) {
                console.error("Error saving medication:", error);
            }
        };

        // Delete medication from Firestore
        const deleteMedication = async () => {
            if (!isAuthReady || !db || !userId || !currentEditingMedId) return;

            // Use a custom modal for confirmation instead of alert/confirm
            const confirmDelete = await showConfirmationModal("Are you sure you want to delete this medication? This action cannot be undone.");

            if (confirmDelete) {
                try {
                    const medRef = doc(db, `artifacts/${appId}/users/${userId}/medications`, currentEditingMedId);
                    await deleteDoc(medRef);
                    console.log("Medication deleted successfully!");
                    medicationModal.classList.remove('show');
                    medicationForm.reset();
                    currentEditingMedId = null;
                    medInfoOutput.classList.add('hidden'); // Hide LLM output on delete
                    medInfoOutput.innerHTML = '';
                } catch (error) {
                    console.error("Error deleting medication:", error);
                }
            }
        };

        // --- LLM Integration Functions ---

        // Function to get medication info using Gemini API
        const getMedicationInfo = async () => {
            const medName = medNameInput.value;
            if (!medName) {
                medInfoOutput.classList.remove('hidden');
                medInfoOutput.innerHTML = '<p class="text-red-600">Please enter a medication name.</p>';
                return;
            }

            medInfoOutput.classList.remove('hidden');
            medInfoOutput.innerHTML = '<p class="text-blue-600">Generating information...</p>';

            try {
                let chatHistory = [];
                const prompt = `Tell me general information, common side effects, and any important notes or precautions about the medication "${medName}". The information should be concise and easy to understand.`;
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    medInfoOutput.innerHTML = `<p>${text}</p>`;
                } else {
                    medInfoOutput.innerHTML = '<p class="text-red-600">Unable to generate information. Please try again.</p>';
                }
            } catch (error) {
                console.error("Error calling Gemini API for med info:", error);
                medInfoOutput.innerHTML = '<p class="text-red-600">API call error. Please check your internet connection.</p>';
            }
        };

        // Function to generate refill reminder using Gemini API
        const generateRefillReminder = async () => {
            refillReminderOutput.classList.remove('hidden');
            refillReminderOutput.innerHTML = '<p class="text-yellow-700">Generating reminder...</p>';

            const lowStockMeds = medications.filter(med => {
                const pillsPerDay = getPillsPerDay(med.frequency);
                const daysSupplyLeft = pillsPerDay > 0 ? Math.floor(med.currentStock / pillsPerDay) : Infinity;
                return med.currentStock <= 0 || daysSupplyLeft <= 7;
            });

            if (lowStockMeds.length === 0) {
                refillReminderOutput.innerHTML = '<p class="text-green-700">All medications are in sufficient stock!</p>';
                return;
            }

            let reminderPrompt = "Write a polite and concise refill reminder message for me. I need to refill these medications:\n";
            lowStockMeds.forEach(med => {
                const pillsPerDay = getPillsPerDay(med.frequency);
                const daysSupplyLeft = pillsPerDay > 0 ? Math.floor(med.currentStock / pillsPerDay) : Infinity;
                let statusDetail = '';
                if (med.currentStock <= 0) {
                    statusDetail = 'out of stock';
                } else if (daysSupplyLeft <= 7) {
                    statusDetail = `${daysSupplyLeft} days supply left`;
                }
                reminderPrompt += `- ${med.name} (${statusDetail})\n`;
            });
            reminderPrompt += "Encourage me to refill as soon as possible.";


            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: reminderPrompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    refillReminderOutput.innerHTML = `<p>${text}</p>`;
                } else {
                    refillReminderOutput.innerHTML = '<p class="text-red-600">Unable to generate reminder. Please try again.</p>';
                }
            } catch (error) {
                console.error("Error calling Gemini API for refill reminder:", error);
                refillReminderOutput.innerHTML = '<p class="text-red-600">API call error. Please check your internet connection.</p>';
            }
        };


        // --- UI Rendering Functions ---

        // Render Today's Checklist
        const renderTodayChecklist = () => {
            medsTodayContainer.innerHTML = '<p class="text-gray-500 text-center" id="loading-today-meds">Loading today\'s medications...</p>'; // Loading state
            if (!isAuthReady) {
                medsTodayContainer.innerHTML = '<p class="text-gray-500 text-center">Authenticating...</p>';
                return;
            }
            if (medications.length === 0) {
                medsTodayContainer.innerHTML = '<p class="text-gray-500 text-center">No medications added yet. Click "Manage Medications" to add some!</p>';
                return;
            }

            medsTodayContainer.innerHTML = ''; // Clear previous content

            // Group medications by time of day for better organization
            const timeBlocks = {
                'Before Breakfast': [],
                'Morning': [],
                'After Breakfast': [],
                'After Dinner': [],
                'Evening': [],
                'Anytime / Other': [] // Catch-all for other frequencies or if 'times' is empty
            };

            medications.forEach(med => {
                // Ensure med.times is an array and has content
                if (med.times && med.times.length > 0) {
                    med.times.forEach(time => {
                        if (timeBlocks[time]) {
                            timeBlocks[time].push(med);
                        } else {
                            timeBlocks['Anytime / Other'].push(med);
                        }
                    });
                } else {
                    timeBlocks['Anytime / Other'].push(med); // If no specific time, put in 'Anytime'
                }
            });

            for (const time in timeBlocks) {
                if (timeBlocks[time].length > 0) {
                    const timeSection = document.createElement('div');
                    timeSection.className = 'mb-4 p-4 bg-white rounded-xl shadow-md border border-gray-100';
                    timeSection.innerHTML = `
                        <div class="flex items-center justify-between mb-3 border-b-2 border-indigo-200 pb-2">
                            <h3 class="text-lg font-semibold text-indigo-700">${time}</h3>
                            <button data-time-block="${time}" class="mark-all-btn px-4 py-2 bg-indigo-200 text-indigo-700 text-sm font-medium rounded-lg hover:bg-indigo-300 transition-colors duration-200">
                                Mark All Taken
                            </button>
                        </div>
                        <div class="space-y-3" id="meds-for-${time.replace(/\s+/g, '-')}-block">
                            <!-- Individual meds will go here -->
                        </div>
                    `;

                    const medsForBlockContainer = timeSection.querySelector(`#meds-for-${time.replace(/\s+/g, '-')}-block`);

                    timeBlocks[time].forEach(med => {
                        const isTaken = dailyTakenStatus[med.id + '_' + time] || false;
                        const medItem = document.createElement('div');
                        medItem.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-100';
                        medItem.innerHTML = `
                            <span class="text-base font-medium text-gray-800">${med.name} <span class="text-gray-500 text-sm">(${med.dosage})</span></span>
                            <button data-med-id="${med.id}" data-time-block="${time}" class="toggle-taken-btn w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 ease-in-out
                                ${isTaken ? 'bg-green-500 text-white shadow-md' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
                                ${isTaken ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' : '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'}
                            </button>
                        `;
                        medsForBlockContainer.appendChild(medItem);
                    });
                    medsTodayContainer.appendChild(timeSection);
                }
            }

            // Add event listeners for toggle buttons
            document.querySelectorAll('.toggle-taken-btn').forEach(button => {
                button.onclick = (event) => {
                    const medId = event.currentTarget.dataset.medId;
                    const timeBlock = event.currentTarget.dataset.timeBlock;
                    const isTaken = !dailyTakenStatus[medId + '_' + timeBlock]; // New state
                    updateDailyStatusInFirestore(medId, timeBlock, isTaken);
                };
            });

            // Add event listeners for Mark All Taken buttons
            document.querySelectorAll('.mark-all-btn').forEach(button => {
                button.onclick = async (event) => {
                    const timeBlockToMark = event.currentTarget.dataset.timeBlock;
                    const medsInBlock = timeBlocks[timeBlockToMark];
                    
                    // Mark all as taken locally first
                    medsInBlock.forEach(med => {
                        dailyTakenStatus[med.id + '_' + timeBlockToMark] = true;
                    });
                    renderTodayChecklist(); // Re-render UI immediately

                    // Update Firestore for each med in the block
                    for (const med of medsInBlock) {
                        await updateDailyStatusInFirestore(med.id, timeBlockToMark, true);
                    }
                };
            });
        };

        // Render All Medications List
        const renderAllMedsList = () => {
            medsListTableBody.innerHTML = '<p class="text-gray-500 text-center">Loading all medications...</p>'; // Loading state
            if (medications.length === 0) {
                medsListTableBody.innerHTML = '<tr><td colspan="5" class="py-3 px-6 text-center text-gray-500">No medications added yet.</td></tr>';
                return;
            }
            medsListTableBody.innerHTML = ''; // Clear previous content
            medications.forEach(med => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap font-medium">${med.name}</td>
                    <td class="py-3 px-6 text-left">${med.dosage}</td>
                    <td class="py-3 px-6 text-left">${med.frequency}</td>
                    <td class="py-3 px-6 text-left">${(med.times && med.times.length > 0) ? med.times.join(', ') : 'N/A'}</td>
                    <td class="py-3 px-6 text-left text-gray-500">${med.notes || 'N/A'}</td>
                `;
                medsListTableBody.appendChild(row);
            });
        };

        // Render Refill Status
        const renderRefillStatus = () => {
            refillStatusList.innerHTML = '<p class="text-gray-500 text-center">Loading refill status...</p>'; // Loading state
            if (medications.length === 0) {
                refillStatusList.innerHTML = '<p class="text-gray-500 text-center">No medications to track refill for.</p>';
                return;
            }
            refillStatusList.innerHTML = ''; // Clear previous content
            medications.forEach(med => {
                const pillsPerDay = getPillsPerDay(med.frequency);
                const daysSupplyLeft = pillsPerDay > 0 ? Math.floor(med.currentStock / pillsPerDay) : Infinity; // Avoid division by zero
                const refillDateFromSupply = new Date(today); // 'today' is now globally available
                if (daysSupplyLeft !== Infinity) {
                    refillDateFromSupply.setDate(today.getDate() + daysSupplyLeft);
                }

                let statusText = '';
                let statusColor = 'text-gray-700';
                let statusIcon = '';

                if (med.currentStock <= 0) {
                    statusText = `Out of Stock!`;
                    statusColor = 'text-red-600 font-semibold';
                    statusIcon = '<svg class="w-5 h-5 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>'; // Warning icon
                } else if (daysSupplyLeft <= 7) {
                    statusText = `Low Stock: ${med.currentStock} left (${daysSupplyLeft} days supply)`;
                    statusColor = 'text-orange-600 font-semibold';
                    statusIcon = '<svg class="w-5 h-5 mr-2 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // Clock icon
                } else {
                    statusText = `In Stock: ${med.currentStock} left (${daysSupplyLeft} days supply)`;
                    statusColor = 'text-green-600 font-semibold';
                    statusIcon = '<svg class="w-5 h-5 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // Checkmark icon
                }

                const listItem = document.createElement('li');
                listItem.className = 'flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100';
                listItem.innerHTML = `
                    ${statusIcon}
                    <span class="font-medium text-gray-800 mr-2">${med.name}:</span>
                    <span class="${statusColor}">${statusText}</span>
                    ${med.refillDue ? `<span class="ml-auto text-gray-500 text-sm">Refill by: ${new Date(med.refillDue).toLocaleDateString('en-US')}</span>` : ''}
                `;
                refillStatusList.appendChild(listItem);
            });
        };

        // Populate the select dropdown in the modal with current medications
        const populateMedicationSelect = () => {
            selectMedToEdit.innerHTML = '<option value="">-- Add New or Select to Edit --</option>';
            medications.forEach(med => {
                const option = document.createElement('option');
                option.value = med.id;
                option.textContent = med.name;
                selectMedToEdit.appendChild(option);
            });
        };

        // Fill the form with selected medication data
        const fillFormWithMedData = (medId) => {
            currentEditingMedId = medId;
            if (!medId) {
                medicationForm.reset();
                deleteMedBtn.style.display = 'none'; // Hide delete button for new med
                medInfoOutput.classList.add('hidden'); // Hide LLM output
                medInfoOutput.innerHTML = '';
                return;
            }
            const med = medications.find(m => m.id === medId);
            if (med) {
                medNameInput.value = med.name;
                medDosageInput.value = med.dosage;
                medFrequencySelect.value = med.frequency;
                medTimesInput.value = (med.times && med.times.length > 0) ? med.times.join(', ') : '';
                medNotesInput.value = med.notes || '';
                medCurrentStockInput.value = med.currentStock;
                medPillsPerPackInput.value = med.pillsPerPack;
                medRefillDueInput.value = med.refillDue || ''; // YYYY-MM-DD format
                deleteMedBtn.style.display = 'inline-block'; // Show delete button for existing med
                medInfoOutput.classList.add('hidden'); // Hide LLM output
                medInfoOutput.innerHTML = '';
            }
        };

        // Custom confirmation modal
        const showConfirmationModal = (message) => {
            return new Promise((resolve) => {
                const modalHtml = `
                    <div id="confirmation-modal" class="modal show">
                        <div class="modal-content max-w-sm">
                            <p class="text-lg font-semibold mb-4">${message}</p>
                            <div class="flex justify-end space-x-4">
                                <button id="confirm-yes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl transition-colors">Yes</button>
                                <button id="confirm-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition-colors">No</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const confirmModal = document.getElementById('confirmation-modal');
                document.getElementById('confirm-yes').onclick = () => {
                    confirmModal.remove();
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    confirmModal.remove();
                    resolve(false);
                };
            });
        };


        // --- Event Listeners ---

        // Set current date on load
        todayDateElement.textContent = today.toLocaleDateString('en-US', options);

        // Reset Daily Status Button
        resetDailyStatusButton.addEventListener('click', async () => {
            const confirmReset = await showConfirmationModal("Are you sure you want to reset today's medication status? This will clear all checks for today.");
            if (confirmReset) {
                if (!isAuthReady || !db || !userId) {
                    console.error("Firebase not ready for reset.");
                    dailyTakenStatus = {}; // Clear locally if Firebase not ready
                    renderTodayChecklist();
                    return;
                }
                try {
                    const todayIntakeDocRef = doc(db, `artifacts/${appId}/users/${userId}/dailyIntake`, getTodayDateString());
                    await deleteDoc(todayIntakeDocRef); // Delete today's intake record
                    console.log("Daily status reset successfully!");
                    dailyTakenStatus = {}; // Clear local state after successful deletion
                    renderTodayChecklist(); // Re-render to show all unchecked
                } catch (error) {
                    console.error("Error resetting daily status:", error);
                }
            }
        });

        // Open/Close Modal
        manageMedsBtn.addEventListener('click', () => {
            medicationModal.classList.add('show');
            populateMedicationSelect();
            fillFormWithMedData(null); // Reset form for new entry
        });

        closeModalBtn.addEventListener('click', () => {
            medicationModal.classList.remove('show');
            medicationForm.reset();
            currentEditingMedId = null;
            medInfoOutput.classList.add('hidden'); // Hide LLM output on close
            medInfoOutput.innerHTML = '';
        });

        window.onclick = (event) => {
            if (event.target === medicationModal) {
                medicationModal.classList.remove('show');
                medicationForm.reset();
                currentEditingMedId = null;
                medInfoOutput.classList.add('hidden'); // Hide LLM output on click outside
                medInfoOutput.innerHTML = '';
            }
        };

        // Handle medication selection in modal
        selectMedToEdit.addEventListener('change', (event) => {
            fillFormWithMedData(event.target.value);
        });

        // Handle form submission (add/update)
        medicationForm.addEventListener('submit', saveMedication);

        // Handle delete button click
        deleteMedBtn.addEventListener('click', deleteMedication);

        // Handle Get Med Info button click
        getMedInfoBtn.addEventListener('click', getMedicationInfo);

        // Handle Generate Refill Reminder button click
        generateRefillReminderBtn.addEventListener('click', generateRefillReminder);

        // Initial render calls (will be updated by Firestore snapshots once auth is ready)
        renderAllMedsList();
        renderRefillStatus();
        renderTodayChecklist(); // This will show loading state initially
    </script>
</body>
</html>
